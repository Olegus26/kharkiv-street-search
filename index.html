<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Автоподбор улицы</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e7eefc;margin:24px}
    .card{max-width:760px;margin:0 auto;background:#111a2e;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px}
    label{display:block;font-size:12px;opacity:.9;margin:0 0 6px}
    .field{position:relative}
    input{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid rgba(255,255,255,.12); background:#0b1220; color:#e7eefc; outline:none
    }
    input:focus{border-color:rgba(255,255,255,.24)}
    .dropdown{
      position:absolute; left:0; right:0; top:calc(100% + 6px);
      background:#0b1220; border:1px solid rgba(255,255,255,.12);
      border-radius:12px; overflow:hidden; box-shadow:0 10px 25px rgba(0,0,0,.35);
      display:none; z-index:50; max-height:320px; overflow:auto
    }
    .item{padding:10px 12px; cursor:pointer; display:flex; gap:10px; align-items:baseline}
    .item:hover{background:rgba(255,255,255,.06)}
    .item.active{background:rgba(255,255,255,.10)}
    .type{opacity:.75; font-size:12px; min-width:60px}
    .name{font-weight:600}
    .muted{opacity:.65; font-size:12px}
    .row{margin-top:12px; display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .pill{border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:10px 12px; background:rgba(255,255,255,.03)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 14px;">Поле улицы с подсказками</h2>

    <div class="field">
      <label for="streetInput">Улица</label>
      <input id="streetInput" type="text" placeholder="Начни вводить: сум..., геро..., клоч..." autocomplete="off"/>
      <div id="dropdown" class="dropdown" role="listbox" aria-label="Подсказки улиц"></div>
    </div>

  </div>

<script>
/**
 * Ожидаемый формат JSON: массив объектов
 * { "full": "вул. Сумська", "type": "вул.", "name": "Сумська", "search_key": "..." }
 */
const DATA_URL = "./streets_sorted_ua.json"; // поменяй путь, если нужно

const input = document.getElementById("streetInput");
const dropdown = document.getElementById("dropdown");

const chosenFull = document.getElementById("chosenFull");
const chosenType = document.getElementById("chosenType");
const chosenName = document.getElementById("chosenName");

let streets = [];
let activeIndex = -1;
let currentResults = [];

// --- helpers ---
function normalize(s){
  return String(s || "")
    .toLowerCase()
    .replace(/[’']/g, "'")
    .replace(/ё/g,"е")
    .replace(/і/g,"i")
    .replace(/ї/g,"i")
    .replace(/є/g,"e")
    .replace(/ґ/g,"g")
    .replace(/[^a-z0-9а-яієїґ' -]/gi," ")
    .replace(/\s+/g," ")
    .trim();
}

function showDropdown(){ dropdown.style.display = "block"; }
function hideDropdown(){ dropdown.style.display = "none"; activeIndex = -1; }

function render(results){
  dropdown.innerHTML = "";
  activeIndex = -1;
  currentResults = results;

  if (!results.length){ hideDropdown(); return; }

  for (let i=0;i<results.length;i++){
    const it = results[i];
    const div = document.createElement("div");
    div.className = "item";
    div.setAttribute("role","option");
    div.dataset.index = String(i);
    div.innerHTML = `
      <span class="type">${it.type || ""}</span>
      <span class="name">${it.name || it.full}</span>
      <span class="muted">${it.full}</span>
    `;
    div.addEventListener("mousedown", (e) => { // mousedown чтобы не терять фокус до клика
      e.preventDefault();
      selectIndex(i);
    });
    dropdown.appendChild(div);
  }
  showDropdown();
}

function setActive(idx){
  const items = dropdown.querySelectorAll(".item");
  items.forEach(x => x.classList.remove("active"));
  if (idx >= 0 && idx < items.length){
    items[idx].classList.add("active");
    items[idx].scrollIntoView({ block: "nearest" });
  }
  activeIndex = idx;
}

function selectIndex(idx){
  const it = currentResults[idx];
  if (!it) return;

  input.value = it.full;
  chosenFull.textContent = it.full || "—";
  chosenType.textContent = it.type || "—";
  chosenName.textContent = it.name || "—";

  // если надо — тут можно писать в hidden input для формы
  // document.getElementById("hiddenStreetId").value = it.id;

  hideDropdown();
}

// --- search ---
function search(query){
  const q = normalize(query);
  if (!q) return [];

  // быстрый фильтр: сначала начинается-с, потом содержит
  const starts = [];
  const contains = [];

  for (const st of streets){
    const key = st.search_key || normalize(st.full);
    if (key.startsWith(q)) starts.push(st);
    else if (key.includes(q)) contains.push(st);
    if (starts.length + contains.length >= 30) break; // ограничим список
  }

  return starts.concat(contains).slice(0, 30);
}

// --- events ---
input.addEventListener("input", () => {
  const results = search(input.value);
  render(results);
});

input.addEventListener("focus", () => {
  const results = search(input.value);
  render(results);
});

input.addEventListener("keydown", (e) => {
  const isOpen = dropdown.style.display === "block";
  if (!isOpen && (e.key === "ArrowDown" || e.key === "ArrowUp")){
    const results = search(input.value);
    render(results);
    return;
  }

  if (!isOpen) return;

  if (e.key === "ArrowDown"){
    e.preventDefault();
    setActive(Math.min(activeIndex + 1, currentResults.length - 1));
  } else if (e.key === "ArrowUp"){
    e.preventDefault();
    setActive(Math.max(activeIndex - 1, 0));
  } else if (e.key === "Enter"){
    if (activeIndex >= 0){
      e.preventDefault();
      selectIndex(activeIndex);
    }
  } else if (e.key === "Escape"){
    hideDropdown();
  }
});

document.addEventListener("click", (e) => {
  if (!dropdown.contains(e.target) && e.target !== input) hideDropdown();
});

// --- load data ---
(async function init(){
  try{
    const res = await fetch(DATA_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    streets = await res.json();

    // Подстрахуемся: если нет search_key — создадим на лету
    streets = (Array.isArray(streets) ? streets : []).map(s => ({
      ...s,
      search_key: s.search_key || normalize(s.full)
    }));

    // Чтобы поиск "startsWith" был быстрее — сортируем по search_key
    streets.sort((a,b)=> (a.search_key || "").localeCompare(b.search_key || ""));
  } catch(err){
    console.error(err);
    alert("Не удалось загрузить streets_sorted_ua.json. Открой через Live Server или проверь путь.");
  }
})();
</script>
</body>
</html>
